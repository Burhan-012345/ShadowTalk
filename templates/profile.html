{% extends "base.html" %} {% block content %}
<div class="profile-container">
  <div class="profile-header">
    <div class="profile-avatar">
      {% if current_user.avatar_url and current_user.avatar_url != 'None' %}
        <img src="{{ current_user.avatar_url }}" alt="Profile Avatar" class="avatar-image" onerror="handleAvatarError(this)">
      {% else %}
        <div class="avatar-initials">
          {{ current_user.display_name[0]|upper if current_user.display_name else 'U' }}
        </div>
      {% endif %}
      <div class="avatar-overlay" onclick="openEditModal()">
        <i class="fas fa-camera"></i>
      </div>
    </div>
    <div class="profile-info">
      <div class="profile-header-actions">
        <h1>{{ current_user.display_name }}</h1>
        <button class="btn-edit" onclick="openEditModal()">
          <i class="fas fa-edit"></i> Edit Profile
        </button>
      </div>
      <p>@{{ current_user.username }}</p>
      <p class="profile-bio">{{ current_user.bio or "No bio yet" }}</p>
      <div class="profile-stats">
        <div class="stat">
          <span class="stat-number">{{ connections|length }}</span>
          <span class="stat-label">Connections</span>
        </div>
        <div class="stat">
          <span class="stat-number">{{ current_user.age or '--' }}</span>
          <span class="stat-label">Age</span>
        </div>
        <div class="stat">
          <span class="stat-number">{{ current_user.gender or 'Not specified' }}</span>
          <span class="stat-label">Gender</span>
        </div>
      </div>
      {% if current_user.interests and current_user.interests_list %}
      <div class="profile-interests">
        <h4>Interests</h4>
        <div class="interests-tags">
          {% for interest in current_user.interests_list %}
            {% if interest and interest.strip() %}
            <span class="interest-tag">{{ interest }}</span>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="profile-content">
    <div class="connections-section">
      <h2>Your Connections</h2>
      {% if connections %}
      <div class="connections-grid">
        {% for connection in connections %}
        <div class="connection-card">
          <div class="connection-avatar">
            {% if connection.user.avatar_url and connection.user.avatar_url != 'None' %}
              <img src="{{ connection.user.avatar_url }}" alt="{{ connection.user.display_name }}" class="avatar-image" onerror="handleConnectionAvatarError(this)">
            {% else %}
              <div class="avatar-initials">
                {{ connection.user.display_name[0]|upper if connection.user.display_name else 'U' }}
              </div>
            {% endif %}
          </div>
          <div class="connection-info">
            <h3>{{ connection.user.display_name }}</h3>
            <p>Chatted {{ connection.chat_count }} time(s)</p>
            <p class="connection-last">
              Last: {{ connection.last_chat.strftime('%Y-%m-%d') if connection.last_chat else 'Never' }}
            </p>
          </div>
          <div class="connection-actions">
            <button
              class="btn-primary"
              onclick="sendConnectionRequest('{{ connection.user.id }}')"
            >
              Connect Again
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <i class="fas fa-users"></i>
        <h3>No connections yet</h3>
        <p>Start chatting to build your connection list</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal" id="editProfileModal">
  <div class="modal-content profile-modal">
    <div class="modal-header">
      <h2>Edit Profile</h2>
      <button class="close-btn" onclick="closeEditModal()">&times;</button>
    </div>
    <form id="editProfileForm" method="POST" action="{{ url_for('update_profile') }}" enctype="multipart/form-data">
      <div class="modal-body">
        <!-- Avatar Section -->
        <div class="form-section">
          <h3>Profile Picture</h3>
          <div class="avatar-upload-section">
            <div class="avatar-preview-edit">
              {% if current_user.avatar_url and current_user.avatar_url != 'None' %}
                <img id="avatarPreview" src="{{ current_user.avatar_url }}" alt="Avatar Preview" onerror="useInitialsAvatar()">
              {% else %}
                <div id="avatarPreview" class="avatar-initials">
                  {{ current_user.display_name[0]|upper if current_user.display_name else 'U' }}
                </div>
              {% endif %}
            </div>
            <div class="avatar-upload-options">
              <label class="upload-option">
                <input type="file" id="avatarUpload" name="avatar" accept="image/*" style="display: none;" onchange="previewAvatar(this)">
                <i class="fas fa-upload"></i>
                Upload Photo
              </label>
              <button type="button" class="btn-secondary" onclick="generateRandomAvatar()">
                <i class="fas fa-robot"></i>
                Generate AI Avatar
              </button>
              <button type="button" class="btn-secondary" onclick="useInitialsAvatar()">
                <i class="fas fa-user-circle"></i>
                Use Initials
              </button>
              <button type="button" class="btn-danger" onclick="removeAvatar()">
                <i class="fas fa-trash"></i>
                Remove Photo
              </button>
            </div>
          </div>
          <input type="hidden" id="avatarData" name="avatar_data" value="">
          <input type="hidden" id="removeAvatarFlag" name="remove_avatar" value="false">
        </div>

        <!-- Basic Information -->
        <div class="form-section">
          <h3>Basic Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="edit_display_name">Display Name *</label>
              <input type="text" id="edit_display_name" name="display_name" value="{{ current_user.display_name }}" required>
            </div>
            <div class="form-group">
              <label for="edit_username">Username *</label>
              <input type="text" id="edit_username" name="username" value="{{ current_user.username }}" required>
              <div class="input-feedback" id="usernameFeedback"></div>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="edit_age">Age</label>
              <input type="number" id="edit_age" name="age" value="{{ current_user.age }}" min="13" max="100">
            </div>
            <div class="form-group">
              <label for="edit_gender">Gender</label>
              <select id="edit_gender" name="gender">
                <option value="">Prefer not to say</option>
                <option value="male" {% if current_user.gender == 'male' %}selected{% endif %}>Male</option>
                <option value="female" {% if current_user.gender == 'female' %}selected{% endif %}>Female</option>
                <option value="non-binary" {% if current_user.gender == 'non-binary' %}selected{% endif %}>Non-binary</option>
                <option value="other" {% if current_user.gender == 'other' %}selected{% endif %}>Other</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Bio Section -->
        <div class="form-section">
          <h3>About Me</h3>
          <div class="form-group">
            <label for="edit_bio">Bio</label>
            <textarea id="edit_bio" name="bio" rows="4" placeholder="Tell others about yourself...">{{ current_user.bio or '' }}</textarea>
            <div class="char-counter">
              <span id="bioCharCount">{{ (current_user.bio or '')|length }}</span>/200 characters
            </div>
          </div>
        </div>

        <!-- Interests Section -->
        <div class="form-section">
          <h3>Interests</h3>
          <div class="interests-edit-section">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="editInterestSearch" placeholder="Search interests...">
            </div>
            <div class="interests-grid-edit" id="interestsGridEdit">
              {% set all_interests = ['Technology', 'Music', 'Sports', 'Gaming', 'Movies', 'Books', 
                                     'Travel', 'Food', 'Art', 'Science', 'Fitness', 'Fashion', 
                                     'Photography', 'Nature', 'Business', 'Programming', 'AI', 
                                     'Blockchain', 'Startups', 'Psychology', 'Philosophy', 
                                     'History', 'Politics', 'Environment', 'Space', 'Robotics',
                                     'VR/AR', 'Cryptocurrency', 'Digital Art', 'Podcasts',
                                     'Yoga', 'Meditation', 'Cooking', 'Baking', 'Gardening',
                                     'Anime', 'Manga', 'Comics', 'Board Games', 'Chess',
                                     'Cryptography', 'Cybersecurity', 'Data Science'] %}
              {% for interest in all_interests %}
              <label class="interest-checkbox">
                <input type="checkbox" name="interests" value="{{ interest }}" 
                  {% if interest in (current_user.interests_list or []) %}checked{% endif %}>
                <span class="interest-tag">{{ interest }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="selected-interests-count">
              <span id="selectedInterestsCount">{{ (current_user.interests_list or [])|length }}</span> interests selected
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Notifications Panel -->
<div class="notifications-panel" id="notificationsPanel">
  <div class="notifications-header">
    <h3>Notifications</h3>
    <button class="close-btn" onclick="closeNotifications()">&times;</button>
  </div>
  <div class="notifications-list" id="notificationsList">
    <!-- Notifications will be loaded here -->
  </div>
</div>

<!-- Notification Bell -->
<div class="notification-bell" onclick="toggleNotifications()">
  <i class="fas fa-bell"></i>
  <span class="notification-count" id="notificationCount">0</span>
</div>

<style>
  /* Edit Profile Modal Styles */
  .profile-modal {
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    background: #151522;
    border: 1px solid rgba(99, 102, 241, 0.2);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    border-bottom: 1px solid rgba(99, 102, 241, 0.2);
    background: #1a1a2e;
  }

  .modal-body {
    padding: 30px;
    background: #151522;
  }

  .modal-footer {
    padding: 20px 30px;
    border-top: 1px solid rgba(99, 102, 241, 0.2);
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    background: #1a1a2e;
  }

  .form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(99, 102, 241, 0.2);
    background: #151522;
  }

  .form-section:last-child {
    border-bottom: none;
  }

  .form-section h3 {
    margin-bottom: 20px;
    color: #6366f1;
    font-size: 1.2em;
  }

  /* Avatar Upload Section */
  .avatar-upload-section {
    display: flex;
    gap: 30px;
    align-items: flex-start;
    background: #1a1a2e;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid rgba(99, 102, 241, 0.2);
  }

  .avatar-preview-edit {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid #6366f1;
    position: relative;
    background: #0a0a0f;
  }

  .avatar-preview-edit img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Avatar Initials Styles */
  .avatar-initials {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #3b82f6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2.5em;
    font-weight: bold;
    text-transform: uppercase;
  }

  .avatar-upload-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    flex: 1;
  }

  .upload-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    background: #2d2d42;
    border: 2px dashed #555;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #e2e8f0;
  }

  .upload-option:hover {
    border-color: #6366f1;
    background: rgba(99, 102, 241, 0.05);
  }

  .btn-secondary {
    background: #2d2d42;
    color: white;
    border: 1px solid #555;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-secondary:hover {
    background: #3d3d52;
    border-color: #6366f1;
  }

  .btn-primary {
    background: #6366f1;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary:hover {
    background: #4f46e5;
  }

  .btn-danger {
    background: #ef4444;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  /* Profile Header Enhancements */
  .profile-header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .btn-edit {
    background: transparent;
    border: 2px solid #6366f1;
    color: #6366f1;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-edit:hover {
    background: #6366f1;
    color: white;
  }

  .avatar-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    cursor: pointer;
    color: white;
    font-size: 24px;
  }

  .profile-avatar:hover .avatar-overlay {
    opacity: 1;
  }

  .profile-avatar {
    position: relative;
    width: 120px;
    height: 120px;
  }

  .avatar-image {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .connection-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid #6366f1;
    position: relative;
  }

  .connection-avatar .avatar-initials {
    font-size: 1.5em;
  }

  /* Interests in Profile */
  .profile-interests {
    margin-top: 20px;
  }

  .profile-interests h4 {
    margin-bottom: 10px;
    color: #e0e0e0;
  }

  .interests-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .interest-tag {
    display: inline-block;
    background: #6366f1;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.9em;
  }

  /* Interests Edit Section */
  .interests-edit-section {
    background: #1a1a2e;
    border-radius: 10px;
    padding: 20px;
    border: 1px solid rgba(99, 102, 241, 0.2);
  }

  .search-box {
    position: relative;
    margin-bottom: 15px;
  }

  .search-box i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #888;
  }

  .search-box input {
    width: 100%;
    padding: 10px 10px 10px 35px;
    background: #2d2d42;
    border: 1px solid #555;
    border-radius: 8px;
    color: white;
  }

  .interests-grid-edit {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
    padding: 15px;
    background: #0a0a0f;
    border-radius: 8px;
    margin: 15px 0;
  }

  .interest-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: background 0.3s ease;
  }

  .interest-checkbox:hover {
    background: #2d2d42;
  }

  .interest-checkbox input {
    margin-right: 8px;
  }

  .selected-interests-count {
    text-align: center;
    color: #6366f1;
    font-weight: bold;
    padding: 10px;
  }

  /* Form Improvements */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    color: #e0e0e0;
    font-weight: 500;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 12px 16px;
    background: #2d2d42;
    border: 2px solid #555;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    transition: all 0.3s ease;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: #6366f1;
    outline: none;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .char-counter {
    text-align: right;
    font-size: 12px;
    color: #888;
    margin-top: 5px;
  }

  .input-feedback {
    margin-top: 5px;
    font-size: 14px;
    min-height: 20px;
  }

  .input-feedback.success { color: #06d6a0; }
  .input-feedback.error { color: #ef4444; }
  .input-feedback.info { color: #3b82f6; }

  /* Profile Content */
  .profile-content {
    margin-top: 40px;
  }

  .connections-section h2 {
    margin-bottom: 20px;
    color: #e0e0e0;
  }

  .connections-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
  }

  .connection-card {
    background: #1a1a2e;
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
  }

  .connection-card:hover {
    border-color: #6366f1;
    transform: translateY(-2px);
  }

  .connection-info {
    flex: 1;
  }

  .connection-info h3 {
    margin: 0 0 5px 0;
    color: #e0e0e0;
  }

  .connection-info p {
    margin: 2px 0;
    color: #888;
    font-size: 0.9em;
  }

  .connection-actions {
    display: flex;
    gap: 10px;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #888;
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
  }

  .empty-state h3 {
    margin: 0 0 10px 0;
    color: #e0e0e0;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
  }

  .modal-content {
    background-color: #151522;
    margin: 5% auto;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.2);
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #888;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    color: #e0e0e0;
  }

  /* Notifications Panel */
  .notifications-panel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: #151522;
    border-left: 1px solid rgba(99, 102, 241, 0.2);
    transition: right 0.3s ease;
    z-index: 1001;
  }

  .notifications-panel.active {
    right: 0;
  }

  .notifications-header {
    padding: 20px;
    border-bottom: 1px solid rgba(99, 102, 241, 0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #1a1a2e;
  }

  .notifications-list {
    padding: 20px;
    height: calc(100vh - 80px);
    overflow-y: auto;
    background: #151522;
  }

  .notification-item {
    background: #1a1a2e;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    border: 1px solid rgba(99, 102, 241, 0.2);
  }

  .notification-content h4 {
    margin: 0 0 5px 0;
    color: #e0e0e0;
  }

  .notification-content p {
    margin: 0 0 5px 0;
    color: #888;
  }

  .notification-content small {
    color: #666;
  }

  .notification-actions {
    margin-top: 10px;
  }

  .btn-small {
    background: #2d2d42;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }

  .btn-small:hover {
    background: #3d3d52;
  }

  .no-notifications {
    text-align: center;
    color: #888;
    padding: 40px 20px;
  }

  .notification-bell {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #6366f1;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1000;
    font-size: 20px;
  }

  .notification-count {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .profile-modal {
      margin: 20px;
      max-height: 95vh;
    }
    
    .avatar-upload-section {
      flex-direction: column;
      align-items: center;
    }
    
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .profile-header-actions {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }
    
    .interests-grid-edit {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
    
    .connections-grid {
      grid-template-columns: 1fr;
    }
    
    .connection-card {
      flex-direction: column;
      text-align: center;
    }
    
    .notifications-panel {
      width: 100%;
      right: -100%;
    }
    
    .modal-content {
      margin: 10% auto;
      width: 95%;
    }
  }
</style>

<script>
  let socket;
  let avatarDataUrl = "{{ current_user.avatar_url or '' }}";

  // Avatar error handling functions
  function handleAvatarError(imgElement) {
    console.log('Avatar image failed to load, showing initials');
    // Hide the broken image
    imgElement.style.display = 'none';
    
    // Create and show initials
    const avatarContainer = imgElement.parentElement;
    let initialsDiv = avatarContainer.querySelector('.avatar-initials');
    
    if (!initialsDiv) {
      initialsDiv = document.createElement('div');
      initialsDiv.className = 'avatar-initials';
      const displayName = "{{ current_user.display_name }}";
      const initial = displayName && displayName !== 'None' ? displayName[0].toUpperCase() : 'U';
      initialsDiv.textContent = initial;
      avatarContainer.appendChild(initialsDiv);
    }
    
    initialsDiv.style.display = 'flex';
  }

  function handleConnectionAvatarError(imgElement) {
    console.log('Connection avatar image failed to load, showing initials');
    // Hide the broken image
    imgElement.style.display = 'none';
    
    // Create and show initials
    const avatarContainer = imgElement.parentElement;
    let initialsDiv = avatarContainer.querySelector('.avatar-initials');
    
    if (!initialsDiv) {
      initialsDiv = document.createElement('div');
      initialsDiv.className = 'avatar-initials';
      // Try to get the name from the connection info
      const connectionCard = avatarContainer.closest('.connection-card');
      if (connectionCard) {
        const nameElement = connectionCard.querySelector('h3');
        if (nameElement) {
          const connectionName = nameElement.textContent;
          const initial = connectionName ? connectionName[0].toUpperCase() : 'U';
          initialsDiv.textContent = initial;
        } else {
          initialsDiv.textContent = 'U';
        }
      } else {
        initialsDiv.textContent = 'U';
      }
      avatarContainer.appendChild(initialsDiv);
    }
    
    initialsDiv.style.display = 'flex';
  }

  function initializeSocket() {
    if (typeof io !== 'undefined') {
      socket = io();

      socket.on("notification", function (data) {
        loadNotifications();
        showNotification(data.title, data.message);
      });

      socket.on("user_online_status", function (data) {
        console.log("User status update:", data);
      });
    } else {
      console.warn('Socket.IO not loaded');
    }
  }

  function loadNotifications() {
    fetch("/api/notifications")
      .then((response) => response.json())
      .then((notifications) => {
        const list = document.getElementById("notificationsList");
        const count = document.getElementById("notificationCount");

        if (count) {
          count.textContent = notifications.length;
        }

        if (!list) return;

        if (notifications.length === 0) {
          list.innerHTML = '<div class="no-notifications">No new notifications</div>';
          return;
        }

        list.innerHTML = notifications
          .map(
            (notif) => `
                <div class="notification-item" data-id="${notif.id}">
                    <div class="notification-content">
                        <h4>${notif.title || 'Notification'}</h4>
                        <p>${notif.message || ''}</p>
                        <small>${new Date(notif.created_at || Date.now()).toLocaleString()}</small>
                    </div>
                    <div class="notification-actions">
                        <button class="btn-small" onclick="markAsRead('${notif.id}')">Mark Read</button>
                    </div>
                </div>
            `
          )
          .join("");
      })
      .catch(error => {
        console.error('Error loading notifications:', error);
      });
  }

  function markAsRead(notificationId) {
    fetch(`/api/notifications/${notificationId}/read`, { 
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => {
      if (response.ok) {
        loadNotifications();
        if (typeof toastr !== 'undefined') {
          toastr.success('Notification marked as read');
        }
      } else {
        if (typeof toastr !== 'undefined') {
          toastr.error('Failed to mark notification as read');
        }
      }
    })
    .catch(error => {
      console.error('Error marking notification as read:', error);
      if (typeof toastr !== 'undefined') {
        toastr.error('Error marking notification as read');
      }
    });
  }

  function sendConnectionRequest(userId) {
    if (!userId) {
      if (typeof toastr !== 'undefined') {
        toastr.error('Invalid user ID');
      }
      return;
    }

    fetch(`/api/send-connection-request/${userId}`, { 
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
      }
    })
      .then((response) => response.json())
      .then((data) => {
        if (typeof toastr !== 'undefined') {
          if (data.success) {
            toastr.success("Connection request sent!");
          } else {
            toastr.error(data.error || "Failed to send request");
          }
        }
      })
      .catch(error => {
        console.error('Error sending connection request:', error);
        if (typeof toastr !== 'undefined') {
          toastr.error('Error sending connection request');
        }
      });
  }

  function toggleNotifications() {
    const panel = document.getElementById("notificationsPanel");
    if (panel) {
      panel.classList.toggle("active");
      if (panel.classList.contains("active")) {
        loadNotifications();
      }
    }
  }

  function closeNotifications() {
    const panel = document.getElementById("notificationsPanel");
    if (panel) {
      panel.classList.remove("active");
    }
  }

  function showNotification(title, message) {
    if (title && message && typeof toastr !== 'undefined') {
      toastr.info(message, title);
    }
  }

  // Edit Profile Functions
  function openEditModal() {
    const modal = document.getElementById('editProfileModal');
    if (modal) {
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      updateInterestsCount();
      initializeEditForm();
    }
  }

  function closeEditModal() {
    const modal = document.getElementById('editProfileModal');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
      const removeAvatarFlag = document.getElementById('removeAvatarFlag');
      if (removeAvatarFlag) removeAvatarFlag.value = 'false';
    }
  }

  function initializeEditForm() {
    // Bio character counter
    const bioTextarea = document.getElementById('edit_bio');
    const charCount = document.getElementById('bioCharCount');
    
    if (bioTextarea && charCount) {
      bioTextarea.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = count;
        
        if (count > 200) {
          charCount.style.color = '#ef4444';
          this.style.borderColor = '#ef4444';
        } else if (count > 150) {
          charCount.style.color = '#f59e0b';
          this.style.borderColor = '#f59e0b';
        } else {
          charCount.style.color = '#10b981';
          this.style.borderColor = '#555';
        }
      });

      // Trigger initial count
      bioTextarea.dispatchEvent(new Event('input'));
    }

    // Username availability check
    const usernameInput = document.getElementById('edit_username');
    if (usernameInput) {
      usernameInput.addEventListener('input', debounce(checkUsernameAvailability, 500));
    }

    // Interest search
    const interestSearch = document.getElementById('editInterestSearch');
    if (interestSearch) {
      interestSearch.addEventListener('input', debounce(filterEditInterests, 300));
    }

    // Interests count
    updateInterestsCount();
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function updateInterestsCount() {
    const interestCheckboxes = document.querySelectorAll('#interestsGridEdit input[type="checkbox"]');
    let selectedCount = 0;
    
    if (interestCheckboxes) {
      interestCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          selectedCount = document.querySelectorAll('#interestsGridEdit input[type="checkbox"]:checked').length;
          const countElement = document.getElementById('selectedInterestsCount');
          if (countElement) countElement.textContent = selectedCount;
        });
        
        if (checkbox.checked) {
          selectedCount++;
        }
      });
    }
    
    const countElement = document.getElementById('selectedInterestsCount');
    if (countElement) {
      countElement.textContent = selectedCount;
    }
  }

  function filterEditInterests() {
    const searchTerm = document.getElementById('editInterestSearch').value.toLowerCase();
    const interests = document.querySelectorAll('#interestsGridEdit .interest-checkbox');
    
    interests.forEach(interest => {
      const text = interest.textContent.toLowerCase();
      if (text.includes(searchTerm)) {
        interest.style.display = 'block';
      } else {
        interest.style.display = 'none';
      }
    });
  }

  function previewAvatar(input) {
    if (input.files && input.files[0]) {
      // Validate file type
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!validTypes.includes(input.files[0].type)) {
        if (typeof toastr !== 'undefined') {
          toastr.error('Please select a valid image file (JPEG, PNG, GIF, WebP)');
        }
        input.value = '';
        return;
      }
      
      // Validate file size (5MB max)
      const maxSize = 5 * 1024 * 1024;
      if (input.files[0].size > maxSize) {
        if (typeof toastr !== 'undefined') {
          toastr.error('Image size must be less than 5MB');
        }
        input.value = '';
        return;
      }

      const reader = new FileReader();
      
      reader.onload = function(e) {
        updateAvatarPreview(e.target.result);
        if (typeof toastr !== 'undefined') {
          toastr.success('Avatar preview updated!');
        }
      };
      
      reader.onerror = function() {
        if (typeof toastr !== 'undefined') {
          toastr.error('Error reading image file');
        }
        useInitialsAvatar();
      };
      
      reader.readAsDataURL(input.files[0]);
    }
  }

  function updateAvatarPreview(dataUrl) {
    const preview = document.getElementById('avatarPreview');
    if (!preview) return;
    
    console.log('Updating avatar preview with data URL');
    
    // Clear the preview completely - remove all child elements
    while (preview.firstChild) {
        preview.removeChild(preview.firstChild);
    }
    
    // Create image element
    const img = document.createElement('img');
    img.src = dataUrl;
    img.alt = "Avatar Preview";
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    img.onerror = function() {
        console.error('Error loading avatar image');
        if (typeof toastr !== 'undefined') {
            toastr.error('Error loading avatar image');
        }
        useInitialsAvatar();
    };
    
    preview.appendChild(img);
    
    // Clear file input when using AI avatar or initials
    const fileInput = document.getElementById('avatarUpload');
    if (fileInput) fileInput.value = '';
    
    // Set the avatar data for form submission
    avatarDataUrl = dataUrl;
    const avatarDataInput = document.getElementById('avatarData');
    const removeAvatarFlag = document.getElementById('removeAvatarFlag');
    
    if (avatarDataInput) {
        avatarDataInput.value = dataUrl;
        console.log('Avatar data input set');
    }
    if (removeAvatarFlag) {
        removeAvatarFlag.value = 'false';
        console.log('Remove avatar flag set to false');
    }
  }

  async function generateRandomAvatar() {
    try {
        const styles = ['adventurer', 'pixel-art', 'bottts', 'identicon', 'avataaars', 'micah'];
        const randomStyle = styles[Math.floor(Math.random() * styles.length)];
        const seed = Math.random().toString(36).substring(7);
        
        // Use PNG format for better compatibility
        const avatarUrl = `https://api.dicebear.com/7.x/${randomStyle}/png?seed=${seed}&size=150&backgroundColor=8b5cf6`;
        
        console.log('Generating AI avatar from:', avatarUrl);
        
        // Convert the PNG URL to a data URL
        const response = await fetch(avatarUrl);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const blob = await response.blob();
        
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                updateAvatarPreview(e.target.result);
                if (typeof toastr !== 'undefined') {
                    toastr.success('AI avatar generated successfully!');
                }
                resolve(e.target.result);
            };
            
            reader.onerror = function() {
                console.error('Error reading blob data');
                if (typeof toastr !== 'undefined') {
                    toastr.error('Error generating AI avatar');
                }
                reject(new Error('Failed to read avatar data'));
            };
            
            reader.readAsDataURL(blob);
        });
        
    } catch (error) {
        console.error('Error generating AI avatar:', error);
        if (typeof toastr !== 'undefined') {
            toastr.error('Failed to generate AI avatar. Please try again.');
        }
        // Fallback to initials on error
        useInitialsAvatar();
    }
  }

  function useInitialsAvatar() {
    const preview = document.getElementById('avatarPreview');
    if (!preview) return;
    
    // Get display name from input or current user data
    const displayNameInput = document.getElementById('edit_display_name');
    const currentDisplayName = "{{ current_user.display_name }}";
    const displayName = displayNameInput ? displayNameInput.value || currentDisplayName : currentDisplayName || 'User';
    const initial = displayName ? displayName[0].toUpperCase() : 'U';
    
    // Clear the preview completely
    while (preview.firstChild) {
        preview.removeChild(preview.firstChild);
    }
    
    // Create initials display
    const initialsDiv = document.createElement('div');
    initialsDiv.className = 'avatar-initials';
    initialsDiv.textContent = initial;
    initialsDiv.style.width = '100%';
    initialsDiv.style.height = '100%';
    initialsDiv.style.display = 'flex';
    initialsDiv.style.alignItems = 'center';
    initialsDiv.style.justifyContent = 'center';
    initialsDiv.style.fontSize = '2.5em';
    initialsDiv.style.fontWeight = 'bold';
    initialsDiv.style.color = 'white';
    initialsDiv.style.background = 'linear-gradient(135deg, #8b5cf6, #3b82f6)';
    initialsDiv.style.borderRadius = '50%';
    
    preview.appendChild(initialsDiv);
    
    // Clear file input
    const fileInput = document.getElementById('avatarUpload');
    if (fileInput) fileInput.value = '';
    
    // Set flags for form submission
    avatarDataUrl = '';
    const avatarDataInput = document.getElementById('avatarData');
    const removeAvatarFlag = document.getElementById('removeAvatarFlag');
    
    if (avatarDataInput) avatarDataInput.value = '';
    if (removeAvatarFlag) removeAvatarFlag.value = 'true';
    
    if (typeof toastr !== 'undefined') {
        toastr.success('Using initials as avatar!');
    }
    
    console.log('Using initials avatar');
  }

  function removeAvatar() {
    const preview = document.getElementById('avatarPreview');
    if (!preview) return;
    
    // Clear the preview completely
    while (preview.firstChild) {
        preview.removeChild(preview.firstChild);
    }
    
    // Create initials display
    const displayNameInput = document.getElementById('edit_display_name');
    const currentDisplayName = "{{ current_user.display_name }}";
    const displayName = displayNameInput ? displayNameInput.value || currentDisplayName : currentDisplayName || 'User';
    const initial = displayName ? displayName[0].toUpperCase() : 'U';
    
    const initialsDiv = document.createElement('div');
    initialsDiv.className = 'avatar-initials';
    initialsDiv.textContent = initial;
    initialsDiv.style.width = '100%';
    initialsDiv.style.height = '100%';
    initialsDiv.style.display = 'flex';
    initialsDiv.style.alignItems = 'center';
    initialsDiv.style.justifyContent = 'center';
    initialsDiv.style.fontSize = '2.5em';
    initialsDiv.style.fontWeight = 'bold';
    initialsDiv.style.color = 'white';
    initialsDiv.style.background = 'linear-gradient(135deg, #8b5cf6, #3b82f6)';
    initialsDiv.style.borderRadius = '50%';
    
    preview.appendChild(initialsDiv);
    
    // Clear file input
    const fileInput = document.getElementById('avatarUpload');
    if (fileInput) fileInput.value = '';
    
    // Set flags for form submission
    avatarDataUrl = '';
    const avatarDataInput = document.getElementById('avatarData');
    const removeAvatarFlag = document.getElementById('removeAvatarFlag');
    
    if (avatarDataInput) avatarDataInput.value = '';
    if (removeAvatarFlag) removeAvatarFlag.value = 'true';
    
    if (typeof toastr !== 'undefined') {
        toastr.success('Avatar removed successfully!');
    }
    
    console.log('Avatar removed, using initials instead');
  }

  async function checkUsernameAvailability() {
    const usernameInput = document.getElementById('edit_username');
    const feedback = document.getElementById('usernameFeedback');
    
    if (!usernameInput || !feedback) return;
    
    const username = usernameInput.value.trim();
    console.log('🔍 Checking username:', username);
    
    if (!username) {
        feedback.textContent = '';
        feedback.className = 'input-feedback';
        return;
    }
  
    if (username.length < 3) {
        feedback.textContent = 'Username must be at least 3 characters';
        feedback.className = 'input-feedback error';
        return;
    }
  
    if (username === '{{ current_user.username }}') {
        feedback.textContent = 'This is your current username';
        feedback.className = 'input-feedback success';
        return;
    }
  
    const usernameRegex = /^[a-zA-Z0-9_]+$/;
    if (!usernameRegex.test(username)) {
        feedback.textContent = 'Username can only contain letters, numbers, and underscores';
        feedback.className = 'input-feedback error';
        return;
    }
  
    feedback.textContent = 'Checking availability...';
    feedback.className = 'input-feedback info';
  
    try {
        // Use POST method with JSON data
        const response = await fetch('/api/check-username', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username: username })
        });
        
        console.log('🔍 Response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('🔍 API response:', data);
            
            if (data.available) {
                feedback.textContent = 'Username available!';
                feedback.className = 'input-feedback success';
            } else {
                feedback.textContent = data.error || 'Username already taken';
                feedback.className = 'input-feedback error';
            }
        } else {
            console.error('❌ API returned error status:', response.status);
            const errorData = await response.json();
            console.error('❌ Error data:', errorData);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error('❌ Error checking username:', error);
        feedback.textContent = 'Unable to check username availability';
        feedback.className = 'input-feedback error';
    }
  }

  // Form submission handling
  const editProfileForm = document.getElementById('editProfileForm');
  if (editProfileForm) {
    editProfileForm.addEventListener('submit', function(e) {
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      
      // Validate form
      const displayName = document.getElementById('edit_display_name').value.trim();
      const username = document.getElementById('edit_username').value.trim();
      
      if (!displayName) {
        if (typeof toastr !== 'undefined') {
          toastr.error('Display name is required');
        }
        e.preventDefault();
        return;
      }
      
      if (!username) {
        if (typeof toastr !== 'undefined') {
          toastr.error('Username is required');
        }
        e.preventDefault();
        return;
      }
      
      if (username.length < 3) {
        if (typeof toastr !== 'undefined') {
          toastr.error('Username must be at least 3 characters');
        }
        e.preventDefault();
        return;
      }
      
      // Ensure avatar data is properly set
      const removeAvatarFlag = document.getElementById('removeAvatarFlag');
      const avatarDataInput = document.getElementById('avatarData');
      
      if (removeAvatarFlag && removeAvatarFlag.value === 'true') {
        // If removing avatar, clear the avatar data
        if (avatarDataInput) avatarDataInput.value = '';
      }
      
      if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;
        
        // Allow form to submit normally
        setTimeout(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }, 5000);
      }
    });
  }

  // Close modal when clicking outside
  window.addEventListener('click', function(e) {
    const modal = document.getElementById('editProfileModal');
    if (e.target === modal) {
      closeEditModal();
    }
    
    // Close notifications when clicking outside
    const notificationsPanel = document.getElementById('notificationsPanel');
    const notificationBell = document.querySelector('.notification-bell');
    if (notificationsPanel && notificationsPanel.classList.contains('active') && 
        !notificationsPanel.contains(e.target) && 
        notificationBell && !notificationBell.contains(e.target)) {
      closeNotifications();
    }
  });

  // Escape key to close modals
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeEditModal();
      closeNotifications();
    }
  });

  // Initialize when page loads
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize socket connection
    initializeSocket();
    
    // Load notifications
    loadNotifications();
    
    // Initialize any tooltips or other UI components
    initializeUIComponents();
  });

  function initializeUIComponents() {
    console.log('Profile page initialized');
  }

  // Utility function to get CSRF token (if needed)
  function getCSRFToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    return metaTag ? metaTag.getAttribute('content') : '';
  }
</script>
{% endblock %}
