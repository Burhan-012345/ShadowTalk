{% extends "base.html" %} {% block content %}
<div class="auth-container">
  <div class="auth-card">
    <h2 class="auth-title">Set New Password</h2>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %} {% if success %}
    <div class="alert alert-success">{{ success }}</div>
    {% endif %}

    <p class="auth-subtitle">Enter your new password below.</p>

    <form method="POST" class="auth-form" id="resetPasswordForm">
      <div class="form-group">
        <label for="password">New Password</label>
        <div class="password-input-container">
          <input
            type="password"
            id="password"
            name="password"
            required
            class="form-input"
            placeholder="Enter new password"
          />
          <button
            type="button"
            class="toggle-password"
            aria-label="Show password"
          >
            <i class="fas fa-eye"></i>
          </button>
        </div>
        
        <!-- Password Strength Meter -->
        <div class="password-strength-meter">
          <div class="strength-bar">
            <div class="strength-fill" id="strengthFill"></div>
          </div>
          <div class="strength-text" id="strengthText">Password strength</div>
          <div class="ai-security-score" id="aiSecurityScore">
            <i class="fas fa-shield-alt"></i>
            <span>AI Security Score: <span id="securityScoreValue">0</span>/100</span>
          </div>
        </div>
        
        <!-- Password Requirements -->
        <div class="password-requirements">
          <div class="requirement" id="reqLength">
            <i class="fas fa-times"></i>
            <span>At least 8 characters</span>
          </div>
          <div class="requirement" id="reqLowercase">
            <i class="fas fa-times"></i>
            <span>One lowercase letter</span>
          </div>
          <div class="requirement" id="reqUppercase">
            <i class="fas fa-times"></i>
            <span>One uppercase letter</span>
          </div>
          <div class="requirement" id="reqNumber">
            <i class="fas fa-times"></i>
            <span>One number</span>
          </div>
          <div class="requirement" id="reqSpecial">
            <i class="fas fa-times"></i>
            <span>One special character</span>
          </div>
          <div class="requirement" id="reqUncommon">
            <i class="fas fa-times"></i>
            <span>Not a common password</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="confirm_password">Confirm New Password</label>
        <div class="password-input-container">
          <input
            type="password"
            id="confirm_password"
            name="confirm_password"
            required
            class="form-input"
            placeholder="Confirm new password"
          />
          <button
            type="button"
            class="toggle-password"
            aria-label="Show password"
          >
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="password-match" id="passwordMatch">
          <i class="fas fa-times"></i>
          <span>Passwords do not match</span>
        </div>
      </div>

      <button type="submit" class="btn-primary btn-full" id="submitBtn" disabled>
        <span class="btn-text">Reset Password</span>
        <div class="btn-loading" style="display: none;">
          <div class="loading-spinner"></div>
          <span>Processing...</span>
        </div>
      </button>
    </form>

    <div class="auth-links">
      <a href="{{ url_for('login') }}">Back to Login</a>
    </div>
  </div>
</div>

<style>
.password-strength-meter {
  margin-top: 10px;
}

.strength-bar {
  width: 100%;
  height: 6px;
  background-color: #e0e0e0;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 5px;
}

.strength-fill {
  height: 100%;
  width: 0%;
  transition: all 0.3s ease;
  border-radius: 3px;
}

.strength-text {
  font-size: 12px;
  color: #666;
  text-align: right;
}

.ai-security-score {
  display: flex;
  align-items: center;
  font-size: 12px;
  margin-top: 5px;
  color: #666;
  transition: all 0.3s ease;
}

.ai-security-score i {
  margin-right: 5px;
  color: #8b5cf6;
}

.ai-security-score.strong {
  color: #27ae60;
}

.ai-security-score.weak {
  color: #e74c3c;
}

.password-requirements {
  margin-top: 15px;
  font-size: 12px;
}

.requirement {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
  color: #666;
  transition: all 0.3s ease;
  transform: translateX(0);
}

.requirement i {
  margin-right: 8px;
  width: 12px;
  text-align: center;
  transition: all 0.3s ease;
}

.requirement.valid {
  color: #27ae60;
  transform: translateX(5px);
}

.requirement.valid i {
  color: #27ae60;
}

.password-match {
  display: flex;
  align-items: center;
  margin-top: 5px;
  font-size: 12px;
  color: #e74c3c;
  display: none;
  transition: all 0.3s ease;
}

.password-match.visible {
  display: flex;
  animation: slideIn 0.3s ease-out;
}

.password-match.valid {
  color: #27ae60;
}

.password-match i {
  margin-right: 8px;
  width: 12px;
  text-align: center;
}

/* Strength levels */
.strength-weak { background-color: #e74c3c; }
.strength-fair { background-color: #f39c12; }
.strength-good { background-color: #3498db; }
.strength-strong { background-color: #27ae60; }

.btn-primary:disabled {
  background-color: #bdc3c7;
  cursor: not-allowed;
}

.form-input {
  transition: all 0.3s ease;
  border: 2px solid #e0e0e0;
}

.form-input:focus {
  border-color: #8b5cf6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.password-input-container {
  position: relative;
}

.toggle-password {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #666;
  cursor: pointer;
  transition: color 0.3s ease;
}

.toggle-password:hover {
  color: #8b5cf6;
}

.btn-primary {
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}

.btn-primary .btn-text,
.btn-primary .btn-loading {
  transition: opacity 0.3s ease;
}

.btn-primary .btn-loading {
  display: flex;
  align-items: center;
  justify-content: center;
}

.loading-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid transparent;
  border-top: 2px solid #ffffff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.requirement.pulse {
  animation: pulse 0.5s ease-in-out;
}

.auth-card {
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.alert {
  animation: slideIn 0.3s ease-out;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirm_password');
  const strengthFill = document.getElementById('strengthFill');
  const strengthText = document.getElementById('strengthText');
  const securityScore = document.getElementById('aiSecurityScore');
  const securityScoreValue = document.getElementById('securityScoreValue');
  const passwordMatch = document.getElementById('passwordMatch');
  const submitBtn = document.getElementById('submitBtn');
  const toggleButtons = document.querySelectorAll('.toggle-password');
  const form = document.getElementById('resetPasswordForm');
  
  // Requirement elements
  const reqLength = document.getElementById('reqLength');
  const reqLowercase = document.getElementById('reqLowercase');
  const reqUppercase = document.getElementById('reqUppercase');
  const reqNumber = document.getElementById('reqNumber');
  const reqSpecial = document.getElementById('reqSpecial');
  const reqUncommon = document.getElementById('reqUncommon');
  
  // Common passwords for AI security check
  const commonPasswords = [
    'password', '123456', '12345678', '1234', 'qwerty', 'abc123', 
    'password1', '12345', '123456789', 'admin', 'welcome'
  ];
  
  // Password strength criteria
  const requirements = {
    length: { regex: /.{8,}/, element: reqLength },
    lowercase: { regex: /[a-z]/, element: reqLowercase },
    uppercase: { regex: /[A-Z]/, element: reqUppercase },
    number: { regex: /[0-9]/, element: reqNumber },
    special: { regex: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/, element: reqSpecial },
    uncommon: { regex: null, element: reqUncommon } // Will be checked separately
  };
  
  // Toggle password visibility
  toggleButtons.forEach(button => {
    button.addEventListener('click', function() {
      const input = this.parentElement.querySelector('input');
      const icon = this.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
        this.setAttribute('aria-label', 'Hide password');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
        this.setAttribute('aria-label', 'Show password');
      }
    });
  });
  
  // Calculate AI security score
  function calculateSecurityScore(password) {
    let score = 0;
    
    // Length score (max 25 points)
    if (password.length >= 8) score += 10;
    if (password.length >= 12) score += 10;
    if (password.length >= 16) score += 5;
    
    // Character variety score (max 50 points)
    const hasLowercase = /[a-z]/.test(password);
    const hasUppercase = /[A-Z]/.test(password);
    const hasNumbers = /[0-9]/.test(password);
    const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
    
    if (hasLowercase) score += 10;
    if (hasUppercase) score += 10;
    if (hasNumbers) score += 10;
    if (hasSpecial) score += 20;
    
    // Entropy score (max 25 points)
    const charVariety = [hasLowercase, hasUppercase, hasNumbers, hasSpecial].filter(Boolean).length;
    score += charVariety * 6.25;
    
    // Penalty for common passwords
    if (commonPasswords.includes(password.toLowerCase())) {
      score = Math.max(0, score - 50);
    }
    
    // Penalty for sequential characters
    if (/(.)\1{2,}/.test(password)) {
      score = Math.max(0, score - 10);
    }
    
    // Penalty for common patterns
    if (/12345|qwert|asdfg|zxcvb/.test(password.toLowerCase())) {
      score = Math.max(0, score - 15);
    }
    
    return Math.min(100, Math.max(0, score));
  }
  
  // Check password strength
  function checkPasswordStrength(password) {
    let strength = 0;
    let metRequirements = 0;
    const totalRequirements = Object.keys(requirements).length;
    
    // Check each requirement
    Object.keys(requirements).forEach(key => {
      const requirement = requirements[key];
      let isValid = false;
      
      if (key === 'uncommon') {
        isValid = !commonPasswords.includes(password.toLowerCase());
      } else {
        isValid = requirement.regex.test(password);
      }
      
      if (isValid) {
        strength++;
        metRequirements++;
        if (!requirement.element.classList.contains('valid')) {
          requirement.element.classList.add('valid');
          requirement.element.classList.add('pulse');
          setTimeout(() => {
            requirement.element.classList.remove('pulse');
          }, 500);
        }
        requirement.element.querySelector('i').className = 'fas fa-check';
      } else {
        requirement.element.classList.remove('valid');
        requirement.element.querySelector('i').className = 'fas fa-times';
      }
    });
    
    // Calculate strength percentage
    const strengthPercent = (metRequirements / totalRequirements) * 100;
    
    // Update strength meter
    strengthFill.style.width = strengthPercent + '%';
    
    // Set strength level and color
    let strengthLevel = 'weak';
    let strengthMessage = 'Weak';
    
    if (strengthPercent >= 100) {
      strengthLevel = 'strong';
      strengthMessage = 'Strong';
      strengthFill.className = 'strength-fill strength-strong';
    } else if (strengthPercent >= 75) {
      strengthLevel = 'good';
      strengthMessage = 'Good';
      strengthFill.className = 'strength-fill strength-good';
    } else if (strengthPercent >= 50) {
      strengthLevel = 'fair';
      strengthMessage = 'Fair';
      strengthFill.className = 'strength-fill strength-fair';
    } else {
      strengthLevel = 'weak';
      strengthMessage = 'Weak';
      strengthFill.className = 'strength-fill strength-weak';
    }
    
    strengthText.textContent = strengthMessage;
    
    // Update AI security score
    const securityScoreNum = calculateSecurityScore(password);
    securityScoreValue.textContent = securityScoreNum;
    
    if (securityScoreNum >= 80) {
      securityScore.className = 'ai-security-score strong';
    } else if (securityScoreNum >= 60) {
      securityScore.className = 'ai-security-score';
    } else {
      securityScore.className = 'ai-security-score weak';
    }
    
    return strengthPercent === 100 && securityScoreNum >= 70;
  }
  
  // Check if passwords match
  function checkPasswordMatch() {
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    if (confirmPassword === '') {
      passwordMatch.classList.remove('visible');
      return false;
    }
    
    if (password === confirmPassword) {
      passwordMatch.classList.add('visible', 'valid');
      passwordMatch.querySelector('i').className = 'fas fa-check';
      passwordMatch.querySelector('span').textContent = 'Passwords match';
      return true;
    } else {
      passwordMatch.classList.add('visible');
      passwordMatch.classList.remove('valid');
      passwordMatch.querySelector('i').className = 'fas fa-times';
      passwordMatch.querySelector('span').textContent = 'Passwords do not match';
      return false;
    }
  }
  
  // Update form validation
  function updateFormValidation() {
    const isStrongPassword = checkPasswordStrength(passwordInput.value);
    const passwordsMatch = checkPasswordMatch();
    
    // Enable submit button only if all conditions are met
    if (isStrongPassword && passwordsMatch && passwordInput.value !== '') {
      submitBtn.disabled = false;
    } else {
      submitBtn.disabled = true;
    }
  }
  
  // Form submission handler
  form.addEventListener('submit', function(e) {
    const isStrongPassword = checkPasswordStrength(passwordInput.value);
    const passwordsMatch = checkPasswordMatch();
    
    if (!isStrongPassword || !passwordsMatch) {
      e.preventDefault();
      
      // Show error animation
      if (!isStrongPassword) {
        shakeElement(passwordInput);
      }
      if (!passwordsMatch) {
        shakeElement(confirmPasswordInput);
      }
      return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    btnText.style.display = 'none';
    btnLoading.style.display = 'flex';
  });
  
  // Event listeners
  passwordInput.addEventListener('input', updateFormValidation);
  confirmPasswordInput.addEventListener('input', updateFormValidation);
  
  // Initial validation
  updateFormValidation();
  
  // Helper function for shake animation
  function shakeElement(element) {
    element.classList.add('shake');
    setTimeout(() => {
      element.classList.remove('shake');
    }, 500);
  }
});

// Add shake animation to CSS
const style = document.createElement('style');
style.textContent = `
  .shake {
    animation: shake 0.5s ease-in-out;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}