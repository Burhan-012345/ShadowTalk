{% extends "base.html" %} {% block content %}
<div class="auth-container">
  <div class="auth-card">
    <h2 class="auth-title">Verify Your Email</h2>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    <p class="auth-subtitle">
      We've sent a 6-digit OTP to your email address. Please enter it below.
    </p>

    <form method="POST" class="auth-form" id="otpForm">
      <div class="form-group">
        <label for="otp">Enter OTP</label>
        <div class="otp-input-container">
          <input
            type="text"
            id="otp1"
            name="otp1"
            maxlength="1"
            required
            class="otp-input"
            autocomplete="off"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            id="otp2"
            name="otp2"
            maxlength="1"
            required
            class="otp-input"
            autocomplete="off"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            id="otp3"
            name="otp3"
            maxlength="1"
            required
            class="otp-input"
            autocomplete="off"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            id="otp4"
            name="otp4"
            maxlength="1"
            required
            class="otp-input"
            autocomplete="off"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            id="otp5"
            name="otp5"
            maxlength="1"
            required
            class="otp-input"
            autocomplete="off"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            id="otp6"
            name="otp6"
            maxlength="1"
            required
            class="otp-input"
            autocomplete="off"
            inputmode="numeric"
            pattern="[0-9]*"
          />
        </div>
        <input type="hidden" id="otp" name="otp" />

        <!-- OTP Status -->
        <div class="otp-status" id="otpStatus">
          <div class="otp-timer">
            <i class="fas fa-clock"></i>
            <span>Time remaining: <span id="countdown">05:00</span></span>
          </div>
          <div class="otp-validity" id="otpValidity">
            <i class="fas fa-info-circle"></i>
            <span>Enter the 6-digit code</span>
          </div>
        </div>
      </div>

      <button type="submit" class="btn-primary btn-full" id="submitBtn">
        <span class="btn-text">Verify</span>
        <div class="btn-loading" style="display: none">
          <div class="loading-spinner"></div>
          <span>Verifying...</span>
        </div>
      </button>
    </form>

    <div class="auth-links">
      <p>Didn't receive the code? <a href="#" id="resendLink">Resend OTP</a></p>
      <a href="{{ url_for('register') }}">Back to Register</a>
    </div>
  </div>
</div>

<style>
  /* Mobile-First Responsive Styles */
  .auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background: #0a0a0f;
  }

  .auth-card {
    background: #1a1a2e;
    border-radius: 16px;
    padding: 30px 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(99, 102, 241, 0.2);
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
  }

  .auth-title {
    font-size: 1.75rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 10px;
    background: linear-gradient(135deg, #6366f1, #3b82f6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .auth-subtitle {
    text-align: center;
    color: #ccc;
    margin-bottom: 25px;
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 15px;
    font-weight: 600;
    color: #e0e0e0;
    font-size: 0.95rem;
    text-align: center;
  }

  /* OTP Input Container */
  .otp-input-container {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 20px;
    max-width: 320px;
    margin-left: auto;
    margin-right: auto;
  }

  .otp-input {
    width: 45px;
    height: 55px;
    text-align: center;
    font-size: 1.25rem;
    font-weight: bold;
    border: 2px solid #555;
    border-radius: 10px;
    background: #2d2d42;
    color: white;
    transition: all 0.3s ease;
    font-size: 18px; /* Prevent zoom on iOS */
  }

  .otp-input:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    transform: scale(1.05);
    outline: none;
  }

  .otp-input.filled {
    border-color: #27ae60;
    background-color: rgba(39, 174, 96, 0.05);
  }

  .otp-input.error {
    border-color: #e74c3c;
    background-color: rgba(231, 76, 60, 0.05);
    animation: shake 0.5s ease-in-out;
  }

  /* OTP Status */
  .otp-status {
    margin-top: 20px;
    font-size: 0.85rem;
  }

  .otp-timer {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    color: #888;
  }

  .otp-timer i {
    margin-right: 8px;
    color: #8b5cf6;
  }

  .otp-timer.expiring {
    color: #e74c3c;
    animation: pulse 1s infinite;
  }

  .otp-validity {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #888;
    transition: all 0.3s ease;
  }

  .otp-validity i {
    margin-right: 8px;
  }

  .otp-validity.valid {
    color: #27ae60;
  }

  .otp-validity.invalid {
    color: #e74c3c;
  }

  /* Buttons */
  .btn-primary {
    width: 100%;
    padding: 14px 20px;
    background: linear-gradient(135deg, #6366f1, #3b82f6);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-height: 50px;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }

  .btn-primary:disabled {
    background-color: #6b7280;
    cursor: not-allowed;
    transform: none !important;
  }

  .btn-primary .btn-text,
  .btn-primary .btn-loading {
    transition: opacity 0.3s ease;
  }

  .btn-primary .btn-loading {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
  }

  /* Auth Links */
  .auth-links {
    text-align: center;
    margin-top: 25px;
  }

  .auth-links p {
    margin-bottom: 15px;
    color: #888;
    font-size: 0.9rem;
  }

  .auth-links a {
    color: #6366f1;
    text-decoration: none;
    font-size: 0.95rem;
    transition: color 0.3s ease;
  }

  .auth-links a:hover {
    color: #8b5cf6;
    text-decoration: underline;
  }

  #resendLink {
    position: relative;
    overflow: hidden;
    font-weight: 600;
  }

  #resendLink::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background-color: #8b5cf6;
    transform: scaleX(0);
    transform-origin: bottom right;
    transition: transform 0.3s ease;
  }

  #resendLink:hover::after {
    transform: scaleX(1);
    transform-origin: bottom left;
  }

  .resend-disabled {
    color: #95a5a6 !important;
    pointer-events: none;
    cursor: not-allowed;
  }

  /* Alert Styles */
  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 0.9rem;
    animation: slideIn 0.3s ease-out;
  }

  .alert-error {
    background-color: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .alert-success {
    background-color: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
    display: flex;
    align-items: center;
  }

  .alert-success i {
    margin-right: 8px;
  }

  /* Animations */
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes shake {
    0%,
    100% {
      transform: translateX(0);
    }
    25% {
      transform: translateX(-5px);
    }
    75% {
      transform: translateX(5px);
    }
  }

  @keyframes pulse {
    0% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
    100% {
      opacity: 1;
    }
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .auth-card {
    animation: fadeInUp 0.5s ease-out;
  }

  .alert {
    animation: slideIn 0.3s ease-out;
  }

  /* Mobile Optimizations */
  @media (max-width: 480px) {
    .auth-container {
      padding: 15px;
    }

    .auth-card {
      padding: 25px 20px;
    }

    .auth-title {
      font-size: 1.5rem;
    }

    .otp-input-container {
      gap: 6px;
      max-width: 280px;
    }

    .otp-input {
      width: 40px;
      height: 50px;
      font-size: 16px;
    }

    .btn-primary {
      padding: 12px 16px;
      font-size: 0.95rem;
    }

    .otp-status {
      font-size: 0.8rem;
    }
  }

  @media (min-width: 768px) {
    .auth-card {
      padding: 40px 35px;
    }

    .auth-title {
      font-size: 2rem;
    }

    .otp-input-container {
      gap: 10px;
      max-width: 340px;
    }

    .otp-input {
      width: 50px;
      height: 60px;
    }
  }

  @media (max-width: 360px) {
    .otp-input-container {
      gap: 4px;
      max-width: 260px;
    }

    .otp-input {
      width: 38px;
      height: 48px;
      font-size: 15px;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const otpInputs = document.querySelectorAll(".otp-input");
    const hiddenOtpInput = document.getElementById("otp");
    const otpForm = document.getElementById("otpForm");
    const submitBtn = document.getElementById("submitBtn");
    const resendLink = document.getElementById("resendLink");
    const countdownElement = document.getElementById("countdown");
    const otpValidity = document.getElementById("otpValidity");
    const otpTimer = document.querySelector(".otp-timer");

    let countdown;
    let timeLeft = 300; // 5 minutes in seconds
    let canResend = false;

    // Initialize OTP input behavior
    function initializeOTPInputs() {
      otpInputs.forEach((input, index) => {
        // Handle input
        input.addEventListener("input", function (e) {
          const value = e.target.value;

          // Only allow numbers
          if (!/^\d*$/.test(value)) {
            e.target.value = "";
            return;
          }

          // Auto-focus next input
          if (value && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }

          // Update filled state
          updateInputState();
          updateOTPValue();
          validateOTP();
        });

        // Handle backspace
        input.addEventListener("keydown", function (e) {
          if (e.key === "Backspace" && !e.target.value && index > 0) {
            otpInputs[index - 1].focus();
          }
        });

        // Handle paste
        input.addEventListener("paste", function (e) {
          e.preventDefault();
          const pastedData = e.clipboardData.getData("text").slice(0, 6);

          // Fill inputs with pasted data
          pastedData.split("").forEach((char, i) => {
            if (i < otpInputs.length && /^\d$/.test(char)) {
              otpInputs[i].value = char;
            }
          });

          // Focus next empty input or last input
          const nextEmptyIndex = Array.from(otpInputs).findIndex(
            (input) => !input.value
          );
          if (nextEmptyIndex !== -1) {
            otpInputs[nextEmptyIndex].focus();
          } else {
            otpInputs[otpInputs.length - 1].focus();
          }

          updateInputState();
          updateOTPValue();
          validateOTP();
        });

        // Prevent zoom on iOS
        input.addEventListener("focus", function () {
          this.style.fontSize = "18px";
        });
      });
    }

    // Update input visual state
    function updateInputState() {
      otpInputs.forEach((input) => {
        if (input.value) {
          input.classList.add("filled");
          input.classList.remove("error");
        } else {
          input.classList.remove("filled");
        }
      });
    }

    // Update hidden OTP value
    function updateOTPValue() {
      const otpValue = Array.from(otpInputs)
        .map((input) => input.value)
        .join("");
      hiddenOtpInput.value = otpValue;
    }

    // Validate OTP format
    function validateOTP() {
      const otpValue = hiddenOtpInput.value;
      const isValid = /^\d{6}$/.test(otpValue);

      if (otpValue.length === 6) {
        if (isValid) {
          otpValidity.className = "otp-validity valid";
          otpValidity.innerHTML =
            '<i class="fas fa-check-circle"></i><span>Valid OTP format</span>';
        } else {
          otpValidity.className = "otp-validity invalid";
          otpValidity.innerHTML =
            '<i class="fas fa-exclamation-circle"></i><span>Invalid OTP format</span>';
        }
      } else {
        otpValidity.className = "otp-validity";
        otpValidity.innerHTML =
          '<i class="fas fa-info-circle"></i><span>Enter the 6-digit code</span>';
      }

      return isValid;
    }

    // Start countdown timer
    function startCountdown() {
      clearInterval(countdown);

      countdown = setInterval(() => {
        timeLeft--;

        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;

        countdownElement.textContent = `${minutes
          .toString()
          .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

        // Add warning when time is running out
        if (timeLeft <= 60) {
          otpTimer.classList.add("expiring");
        }

        // Enable resend when timer expires
        if (timeLeft <= 0) {
          clearInterval(countdown);
          canResend = true;
          resendLink.classList.remove("resend-disabled");
          countdownElement.textContent = "00:00";
          otpTimer.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i><span>OTP expired</span>';
        }
      }, 1000);
    }

    // Handle form submission
    otpForm.addEventListener("submit", function (e) {
      const otpValue = hiddenOtpInput.value;

      if (!validateOTP()) {
        e.preventDefault();

        // Show error on all inputs
        otpInputs.forEach((input) => {
          input.classList.add("error");
        });

        // Shake animation
        otpForm.classList.add("shake");
        setTimeout(() => {
          otpForm.classList.remove("shake");
        }, 500);

        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      const btnText = submitBtn.querySelector(".btn-text");
      const btnLoading = submitBtn.querySelector(".btn-loading");

      btnText.style.display = "none";
      btnLoading.style.display = "flex";
    });

    // Handle resend OTP
    resendLink.addEventListener("click", function (e) {
      e.preventDefault();

      if (!canResend) return;

      // Reset timer
      timeLeft = 300;
      canResend = false;
      resendLink.classList.add("resend-disabled");
      otpTimer.classList.remove("expiring");
      startCountdown();

      // Clear OTP inputs
      otpInputs.forEach((input) => {
        input.value = "";
        input.classList.remove("filled", "error");
      });

      // Reset validation
      otpValidity.className = "otp-validity";
      otpValidity.innerHTML =
        '<i class="fas fa-info-circle"></i><span>Enter the 6-digit code</span>';

      // Focus first input
      otpInputs[0].focus();

      // Show success message
      const alert = document.createElement("div");
      alert.className = "alert alert-success";
      alert.innerHTML =
        '<i class="fas fa-check-circle"></i> New OTP sent to your email';
      document
        .querySelector(".auth-card")
        .insertBefore(alert, document.querySelector(".auth-subtitle"));

      // Remove alert after 3 seconds
      setTimeout(() => {
        alert.style.opacity = "0";
        alert.style.transform = "translateY(-10px)";
        setTimeout(() => {
          alert.remove();
        }, 300);
      }, 3000);

      // Simulate API call to resend OTP
      console.log("Resending OTP...");
    });

    // Initialize
    initializeOTPInputs();
    startCountdown();

    // Focus first input on page load
    otpInputs[0].focus();
  });

  // Add shake animation to CSS
  const style = document.createElement("style");
  style.textContent = `
  .shake {
    animation: shake 0.5s ease-in-out;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
`;
  document.head.appendChild(style);
</script>
{% endblock %}
