{% extends "base.html" %} {% block content %}
<div class="auth-container">
  <div class="auth-card">
    <h2 class="auth-title">Join ShadowTalk</h2>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    <form method="POST" class="auth-form" id="registerForm">
      <div class="form-group">
        <label for="email">Email</label>
        <input
          type="email"
          id="email"
          name="email"
          required
          class="form-input"
          placeholder="Enter your email"
        />
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <div class="password-input-container">
          <input
            type="password"
            id="password"
            name="password"
            required
            class="form-input"
            placeholder="Create a password"
            oninput="checkPasswordStrength(this.value)"
          />
          <button
            type="button"
            class="toggle-password"
            aria-label="Show password"
          >
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="password-strength-container">
          <div class="password-strength-meter">
            <div class="strength-bar"></div>
          </div>
          <div class="password-strength-text"></div>
        </div>
        <div class="password-requirements">
          <ul>
            <li id="req-length" class="requirement-unmet">
              <i class="fas fa-times"></i>
              At least 8 characters
            </li>
            <li id="req-lowercase" class="requirement-unmet">
              <i class="fas fa-times"></i>
              One lowercase letter
            </li>
            <li id="req-uppercase" class="requirement-unmet">
              <i class="fas fa-times"></i>
              One uppercase letter
            </li>
            <li id="req-number" class="requirement-unmet">
              <i class="fas fa-times"></i>
              One number
            </li>
            <li id="req-special" class="requirement-unmet">
              <i class="fas fa-times"></i>
              One special character
            </li>
          </ul>
        </div>
      </div>

      <div class="form-group">
        <label for="confirm_password">Confirm Password</label>
        <div class="password-input-container">
          <input
            type="password"
            id="confirm_password"
            name="confirm_password"
            required
            class="form-input"
            placeholder="Confirm your password"
            oninput="checkPasswordMatch()"
          />
          <button
            type="button"
            class="toggle-password"
            aria-label="Show password"
          >
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="password-match-feedback"></div>
      </div>

      <button type="submit" class="btn-primary btn-full" id="submitBtn">
        Register
      </button>
    </form>

    <div class="auth-links">
      <a href="{{ url_for('login') }}">Already have an account? Login</a>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  function checkPasswordStrength(password) {
    let strength = 0;
    const requirements = {
      length: false,
      lowercase: false,
      uppercase: false,
      number: false,
      special: false,
    };

    // Check length
    if (password.length >= 8) {
      strength++;
      requirements.length = true;
      updateRequirement("length", true);
    } else {
      updateRequirement("length", false);
    }

    // Check lowercase
    if (/[a-z]/.test(password)) {
      strength++;
      requirements.lowercase = true;
      updateRequirement("lowercase", true);
    } else {
      updateRequirement("lowercase", false);
    }

    // Check uppercase
    if (/[A-Z]/.test(password)) {
      strength++;
      requirements.uppercase = true;
      updateRequirement("uppercase", true);
    } else {
      updateRequirement("uppercase", false);
    }

    // Check numbers
    if (/[0-9]/.test(password)) {
      strength++;
      requirements.number = true;
      updateRequirement("number", true);
    } else {
      updateRequirement("number", false);
    }

    // Check special characters
    if (/[^A-Za-z0-9]/.test(password)) {
      strength++;
      requirements.special = true;
      updateRequirement("special", true);
    } else {
      updateRequirement("special", false);
    }

    updateStrengthMeter(strength, requirements);
    checkPasswordMatch();
  }

  function updateRequirement(type, met) {
    const element = document.getElementById(`req-${type}`);
    const icon = element.querySelector("i");

    if (met) {
      element.classList.remove("requirement-unmet");
      element.classList.add("requirement-met");
      icon.classList.remove("fa-times");
      icon.classList.add("fa-check");
    } else {
      element.classList.remove("requirement-met");
      element.classList.add("requirement-unmet");
      icon.classList.remove("fa-check");
      icon.classList.add("fa-times");
    }
  }

  function updateStrengthMeter(strength, requirements) {
    const meter = document.querySelector(".strength-bar");
    const text = document.querySelector(".password-strength-text");
    const submitBtn = document.getElementById("submitBtn");

    let strengthText = "";
    let strengthColor = "";
    let width = "0%";
    let isStrongEnough = false;

    switch (strength) {
      case 0:
        strengthText = "Very Weak";
        strengthColor = "#ef4444";
        width = "20%";
        break;
      case 1:
        strengthText = "Weak";
        strengthColor = "#f97316";
        width = "40%";
        break;
      case 2:
        strengthText = "Fair";
        strengthColor = "#eab308";
        width = "60%";
        break;
      case 3:
        strengthText = "Good";
        strengthColor = "#84cc16";
        width = "80%";
        break;
      case 4:
        strengthText = "Strong";
        strengthColor = "#22c55e";
        width = "95%";
        isStrongEnough = true;
        break;
      case 5:
        strengthText = "Very Strong";
        strengthColor = "#10b981";
        width = "100%";
        isStrongEnough = true;
        break;
    }

    meter.style.width = width;
    meter.style.backgroundColor = strengthColor;
    text.textContent = `Password Strength: ${strengthText}`;
    text.style.color = strengthColor;

    // Update submit button state based on password strength and match
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirm_password").value;
    const passwordsMatch = password === confirmPassword && password !== "";

    if (isStrongEnough && passwordsMatch) {
      submitBtn.disabled = false;
      submitBtn.title = "";
    } else {
      submitBtn.disabled = true;
      if (!isStrongEnough) {
        submitBtn.title = 'Password must be at least "Strong" to register';
      } else {
        submitBtn.title = "Passwords must match";
      }
    }
  }

  function checkPasswordMatch() {
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirm_password").value;
    const feedback = document.querySelector(".password-match-feedback");
    const submitBtn = document.getElementById("submitBtn");

    if (confirmPassword === "") {
      feedback.textContent = "";
      feedback.className = "password-match-feedback";
      return;
    }

    if (password === confirmPassword) {
      feedback.textContent = "✓ Passwords match";
      feedback.className = "password-match-feedback match";
    } else {
      feedback.textContent = "✗ Passwords do not match";
      feedback.className = "password-match-feedback no-match";
    }

    // Re-check strength to update submit button
    checkPasswordStrength(password);
  }

  // Initialize form validation
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("registerForm");
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirm_password");

    form.addEventListener("submit", function (e) {
      const password = passwordInput.value;
      const confirmPassword = confirmInput.value;

      // Final validation
      if (password !== confirmPassword) {
        e.preventDefault();
        toastr.error("Passwords do not match");
        return;
      }

      // Check password strength requirements
      const strength = calculatePasswordStrength(password);
      if (strength < 4) {
        // Require at least "Strong" password
        e.preventDefault();
        toastr.error(
          "Password is not strong enough. Please ensure it meets all requirements."
        );
        return;
      }
    });

    // Initial state
    updateStrengthMeter(0, {
      length: false,
      lowercase: false,
      uppercase: false,
      number: false,
      special: false,
    });
  });

  function calculatePasswordStrength(password) {
    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    return strength;
  }
</script>
{% endblock %}
